<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>บันทึกรายรับ-รายจ่าย</title>
    <!-- Favicon (inline SVG) -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23059'/%3E%3Ctext x='50' y='57' font-size='48' text-anchor='middle' fill='white' font-family='Arial'%3E%E0%B8%BF%3C/text%3E%3C/svg%3E">
    <!-- Tailwind CSS สำหรับตกแต่ง -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons สำหรับไอคอน -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* ซ่อน scrollbar สำหรับบางส่วนเพื่อความสวยงาม */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* --- Microinteractions & Animations --- */
        button { position: relative; overflow: hidden; }
        .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 520ms linear;
            background: rgba(255,255,255,0.42);
            pointer-events: none;
        }
        @keyframes ripple {
            to { transform: scale(4); opacity: 0; }
        }

        /* Pop animation for newly added transaction */
        .animate-pop { animation: pop .42s cubic-bezier(.22,.9,.28,1); }
        @keyframes pop {
            0% { transform: scale(.92); opacity: 0; }
            60% { transform: scale(1.03); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Toast notifications */
        #toast-container { position: fixed; right: 1rem; bottom: 1.25rem; z-index: 60; display: flex; flex-direction: column; gap: .5rem; }
        .toast { min-width: 180px; max-width: 320px; padding: .5rem .75rem; border-radius: .5rem; box-shadow: 0 8px 20px rgba(2,6,23,0.08); display:flex; gap:.5rem; align-items:center; font-weight:600; color:#fff; }
        .toast-success { background: linear-gradient(90deg,#10b981,#059669); }
        .toast-error { background: linear-gradient(90deg,#ef4444,#b91c1c); }
        .toast-hide { animation: toastOut .4s ease forwards; }
        @keyframes toastOut { to { opacity: 0; transform: translateY(6px); } }
        /* Undo snackbar */
        #undo-snackbar { position: fixed; left: 1rem; bottom: 1.25rem; z-index: 70; display: none; align-items: center; gap: .75rem; background: #0f172a; color: #fff; padding: .5rem .75rem; border-radius: .5rem; box-shadow: 0 8px 24px rgba(2,6,23,0.12); }
        #undo-snackbar .msg { font-weight: 600; }
        #undo-snackbar .undo-btn { background: transparent; border: none; color: #60a5fa; font-weight: 700; padding: .35rem .6rem; border-radius: .375rem; cursor: pointer; }
        /* List enter/exit transitions (use dynamic heights via JS) */
        .list-item { transition: transform .36s cubic-bezier(.22,.9,.28,1), opacity .36s cubic-bezier(.22,.9,.28,1), max-height .36s cubic-bezier(.22,.9,.28,1), margin .36s cubic-bezier(.22,.9,.28,1), padding .36s cubic-bezier(.22,.9,.28,1); overflow: hidden; }
        .list-item-exit { opacity: 0; transform: translateX(8px) scale(.98); max-height: 0 !important; margin: 0 !important; padding: 0 !important; }
        /* hover tilt + lift */
        .list-item:hover { transform: translateY(-6px) scale(1.01); box-shadow: 0 18px 30px rgba(2,6,23,0.08); }
        /* stagger helper (applies transition-delay to items) */
        .stagger-delay { transition-delay: 0ms !important; }
        /* summary value anim */
        .summary-value { display: inline-block; transition: transform .42s cubic-bezier(.22,.9,.28,1); }
        .summary-value-pop { transform: scale(1.06); }
        /* confirm modal */
        #confirm-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 80; }
        #confirm-modal.open { display: flex; }
        #confirm-modal .backdrop { position: absolute; inset: 0; background: rgba(2,6,23,0.48); backdrop-filter: blur(4px); }
        #confirm-modal .dialog { position: relative; background: white; padding: 1rem 1.15rem; border-radius: 0.75rem; width: min(420px, 92%); box-shadow: 0 18px 40px rgba(2,6,23,0.12); transform: scale(.96); opacity: 0; transition: transform .22s cubic-bezier(.22,.9,.28,1), opacity .22s ease; }
        #confirm-modal.open .dialog { transform: scale(1); opacity: 1; }
        #confirm-modal .dialog p { margin: 0; font-weight: 600; }
        #confirm-modal .actions { display:flex; gap:.5rem; justify-content:flex-end; margin-top:.75rem; }
        #confirm-modal .btn { padding:.45rem .8rem; border-radius:.5rem; cursor:pointer; font-weight:700; }
        #confirm-modal .btn-cancel { background:transparent; color:#374151; border:1px solid #e5e7eb; }
        #confirm-modal .btn-confirm { background:#ef4444; color:white; border: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans pb-10 min-h-screen">

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="wallet" class="w-7 h-7"></i>
                <h1 class="text-xl font-bold">บันทึกรายรับ-รายจ่าย</h1>
            </div>
            <button onclick="exportToCSV()" class="flex items-center gap-2 bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-lg transition-colors text-sm">
                <i data-lucide="download" class="w-4 h-4"></i>
                <span class="hidden sm:inline">ส่งออก (CSV)</span>
            </button>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-4 mt-6 space-y-6">
        
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="bg-green-100 p-3 rounded-full text-green-600">
                    <i data-lucide="trending-up" class="w-6 h-6"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">รายรับรวม</p>
                    <p id="summary-income" class="text-xl font-bold text-green-600">฿0.00</p>
                </div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="bg-red-100 p-3 rounded-full text-red-600">
                    <i data-lucide="trending-down" class="w-6 h-6"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">รายจ่ายรวม</p>
                    <p id="summary-expense" class="text-xl font-bold text-red-600">฿0.00</p>
                </div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
                <div id="summary-balance-icon-bg" class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i data-lucide="wallet" class="w-6 h-6"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">ยอดคงเหลือ</p>
                    <p id="summary-balance" class="text-xl font-bold text-blue-600">฿0.00</p>
                </div>
            </div>
        </div>

        <!-- View Controls & Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Column: Input Form -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-fit">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i data-lucide="plus-circle" class="w-5 h-5 text-blue-600"></i>
                    เพิ่มรายการใหม่
                </h2>
                <form id="transaction-form" class="space-y-4">
                    
                    <!-- Type Selection -->
                    <div class="flex bg-gray-100 rounded-lg p-1">
                        <button type="button" id="btn-type-income" onclick="setFormType('income')" class="flex-1 py-2 text-sm font-medium rounded-md transition-all text-gray-500">
                            รายรับ
                        </button>
                        <button type="button" id="btn-type-expense" onclick="setFormType('expense')" class="flex-1 py-2 text-sm font-medium rounded-md transition-all bg-white shadow text-red-600">
                            รายจ่าย
                        </button>
                    </div>

                    <!-- Date & Time Input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">วันที่และเวลา</label>
                        <input type="datetime-local" id="input-datetime" required
                            class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" />
                    </div>

                    <!-- Amount Input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">จำนวนเงิน (บาท)</label>
                        <input type="number" id="input-amount" placeholder="0.00" step="0.01" min="0" required
                            class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" />
                    </div>

                    <!-- Category Input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">หมวดหมู่</label>
                        <div class="relative">
                            <input type="text" id="input-category" placeholder="เช่น อาหาร, เดินทาง" list="category-suggestions" required
                                class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" />
                            <datalist id="category-suggestions"></datalist>
                        </div>
                    </div>

                    <!-- Note Input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">รายละเอียด (ไม่บังคับ)</label>
                        <textarea id="input-note" placeholder="เพิ่มรายละเอียดเพิ่มเติม..." rows="2"
                            class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition resize-none"></textarea>
                    </div>

                    <button type="submit" id="btn-submit" class="w-full py-3 rounded-lg font-bold text-white transition-colors bg-red-600 hover:bg-red-700">
                        บันทึกรายจ่าย
                    </button>
                </form>
            </div>

            <!-- Right Column: List & Filters -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                
                <!-- Filters -->
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6">
                    <h2 class="text-lg font-bold flex items-center gap-2 w-full sm:w-auto">
                        <i data-lucide="list" class="w-5 h-5 text-blue-600"></i>
                        ประวัติรายการ
                    </h2>
                    
                    <div class="flex bg-gray-100 rounded-lg p-1 w-full sm:w-auto overflow-x-auto no-scrollbar">
                        <button onclick="setViewMode('day')" id="view-btn-day" class="view-btn bg-white shadow text-blue-600 px-4 py-1.5 text-sm font-medium rounded-md whitespace-nowrap transition-all">วัน</button>
                        <button onclick="setViewMode('week')" id="view-btn-week" class="view-btn text-gray-500 hover:bg-gray-200 px-4 py-1.5 text-sm font-medium rounded-md whitespace-nowrap transition-all">สัปดาห์</button>
                        <button onclick="setViewMode('month')" id="view-btn-month" class="view-btn text-gray-500 hover:bg-gray-200 px-4 py-1.5 text-sm font-medium rounded-md whitespace-nowrap transition-all">เดือน</button>
                        <button onclick="setViewMode('year')" id="view-btn-year" class="view-btn text-gray-500 hover:bg-gray-200 px-4 py-1.5 text-sm font-medium rounded-md whitespace-nowrap transition-all">ปี</button>
                        <button onclick="setViewMode('all')" id="view-btn-all" class="view-btn text-gray-500 hover:bg-gray-200 px-4 py-1.5 text-sm font-medium rounded-md whitespace-nowrap transition-all">ทั้งหมด</button>
                    </div>
                </div>

                <!-- Date Navigator -->
                <div id="date-navigator" class="flex items-center justify-center gap-4 mb-6 bg-blue-50 py-2 rounded-lg border border-blue-100">
                    <button onclick="navigateDate(-1)" class="p-1 hover:bg-blue-200 rounded-full transition text-blue-700">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    </button>
                    <div class="flex items-center gap-2 font-medium text-blue-800 min-w-[150px] justify-center">
                        <i data-lucide="calendar" class="w-4 h-4"></i>
                        <span id="period-label"></span>
                    </div>
                    <button onclick="navigateDate(1)" class="p-1 hover:bg-blue-200 rounded-full transition text-blue-700">
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- Transaction List -->
                <div id="transaction-list" class="flex-1 overflow-y-auto pr-2 space-y-3 min-h-[300px]">
                    <!-- รายการจะถูกสร้างขึ้นด้วย JavaScript -->
                </div>
            </div>

        </div>
    </main>

    <div id="toast-container"></div>
    <div id="undo-snackbar"><span class="msg">ลบรายการแล้ว</span><button class="undo-btn" id="undo-btn">ยกเลิก</button></div>
    <!-- Animated confirmation modal -->
    <div id="confirm-modal" aria-hidden="true">
        <div class="backdrop" role="presentation"></div>
        <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
            <p id="confirm-title">ยืนยันการลบ</p>
            <p class="confirm-msg text-sm text-gray-600 mt-2">คุณต้องการลบรายการนี้ใช่หรือไม่?</p>
            <div class="actions">
                <button id="confirm-no" class="btn btn-cancel">ยกเลิก</button>
                <button id="confirm-yes" class="btn btn-confirm">ลบ</button>
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        let transactions = JSON.parse(localStorage.getItem('finance_transactions')) || [];
        let viewMode = 'day'; // 'day', 'week', 'month', 'year', 'all'
        let currentDate = new Date();
        let currentFormType = 'expense';

        // หมวดหมู่แนะนำ
        const incomeCategories = ['เงินเดือน', 'โบนัส', 'ค้าขาย', 'ดอกเบี้ย', 'อื่นๆ'];
        const expenseCategories = ['อาหาร', 'เดินทาง', 'ที่พัก', 'ช้อปปิ้ง', 'บิล/ค่าน้ำค่าไฟ', 'บันเทิง', 'อื่นๆ'];

        // --- Helper Functions ---
        const formatCurrency = (num) => {
            return new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(num);
        };

        const getInitialDateTime = () => {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            return now.toISOString().slice(0, 16);
        };

        const saveTransactions = () => {
            localStorage.setItem('finance_transactions', JSON.stringify(transactions));
        };

        // --- Microinteractions: Toast & Ripple ---
        const showToast = (message, type = 'success', duration = 2200) => {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const el = document.createElement('div');
            el.className = `toast ${type === 'success' ? 'toast-success' : 'toast-error'}`;
            el.innerText = message;
            container.appendChild(el);
            setTimeout(() => { el.classList.add('toast-hide'); }, duration - 350);
            setTimeout(() => { container.removeChild(el); }, duration);
        };

        const createRipple = (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const rect = target.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height) * 1.2;
            const ripple = document.createElement('span');
            ripple.className = 'ripple';
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = (e.clientX - rect.left - size/2) + 'px';
            ripple.style.top = (e.clientY - rect.top - size/2) + 'px';
            target.appendChild(ripple);
            setTimeout(() => { ripple.remove(); }, 580);
        };

        // Undo deletion state
        let lastDeleted = null; // { tx, index }
        let finalizeTimer = null;
        const UNDO_DURATION = 5000;

        const showUndoSnackbar = () => {
            const snack = document.getElementById('undo-snackbar');
            if (!snack) return;
            // clear existing timer
            if (finalizeTimer) {
                clearTimeout(finalizeTimer);
                finalizeTimer = null;
            }
            snack.style.display = 'flex';
            // set timer to hide snackbar and finalize deletion
            finalizeTimer = setTimeout(() => {
                snack.style.display = 'none';
                finalizeTimer = null;
                lastDeleted = null;
            }, UNDO_DURATION);
        };

        const hideUndoSnackbar = () => {
            const snack = document.getElementById('undo-snackbar');
            if (!snack) return;
            snack.style.display = 'none';
            if (finalizeTimer) { clearTimeout(finalizeTimer); finalizeTimer = null; }
        };

        const undoDelete = () => {
            if (!lastDeleted) return;
            // re-insert at original index
            const idx = Math.min(Math.max(0, lastDeleted.index), transactions.length);
            transactions.splice(idx, 0, lastDeleted.tx);
            saveTransactions();
            updateUI();
            showToast('คืนค่ารายการแล้ว', 'success');
            lastDeleted = null;
            hideUndoSnackbar();
        };

        // bind undo button
        document.addEventListener('click', (e) => {
            if (e.target && e.target.id === 'undo-btn') {
                undoDelete();
            }
        });

        // delegate delete button clicks inside the list to open confirm modal
        document.getElementById('transaction-list').addEventListener('click', (e) => {
            const btn = e.target.closest && e.target.closest('[data-action="delete"]');
            if (!btn) return;
            const id = btn.dataset.id;
            if (id) showConfirmDelete(id);
        });

        // Smooth height helpers
        const expandElement = (el) => {
            if (!el) return;
            // clear any exit marker
            el.classList.remove('list-item-exit');
            // set initial styles to enable transition from 0
            el.style.willChange = 'max-height, opacity, transform';
            el.style.maxHeight = '0px';
            el.style.opacity = '0';
            el.style.transform = 'translateY(6px)';
            // allow DOM to apply
            requestAnimationFrame(() => {
                const height = el.scrollHeight;
                el.style.maxHeight = height + 'px';
                el.style.opacity = '1';
                el.style.transform = 'translateY(0)';
                // when transition ends, remove explicit maxHeight so content can grow naturally
                const cleanup = () => {
                    el.style.maxHeight = null;
                    el.style.willChange = null;
                    el.removeEventListener('transitionend', cleanup);
                };
                el.addEventListener('transitionend', cleanup);
            });
        };

        const collapseElement = (el, cb) => {
            if (!el) { if (cb) cb(); return; }
            // ensure current height is locked
            const height = el.scrollHeight;
            el.style.maxHeight = height + 'px';
            // force reflow
            // eslint-disable-next-line no-unused-expressions
            el.offsetHeight;
            // then collapse
            requestAnimationFrame(() => {
                el.classList.add('list-item-exit');
                el.style.maxHeight = '0px';
                el.style.opacity = '0';
                el.style.transform = 'translateX(8px) scale(.98)';
                setTimeout(() => { if (cb) cb(); }, 380);
            });
        };

        // --- UI Updaters ---
        const setFormType = (type) => {
            currentFormType = type;
            const btnIncome = document.getElementById('btn-type-income');
            const btnExpense = document.getElementById('btn-type-expense');
            const btnSubmit = document.getElementById('btn-submit');
            const datalist = document.getElementById('category-suggestions');
            const inputCategory = document.getElementById('input-category');

            if (type === 'income') {
                btnIncome.className = "flex-1 py-2 text-sm font-medium rounded-md transition-all bg-white shadow text-green-600";
                btnExpense.className = "flex-1 py-2 text-sm font-medium rounded-md transition-all text-gray-500";
                btnSubmit.className = "w-full py-3 rounded-lg font-bold text-white transition-colors bg-green-600 hover:bg-green-700";
                btnSubmit.innerText = "บันทึกรายรับ";
                
                datalist.innerHTML = incomeCategories.map(cat => `<option value="${cat}">`).join('');
            } else {
                btnIncome.className = "flex-1 py-2 text-sm font-medium rounded-md transition-all text-gray-500";
                btnExpense.className = "flex-1 py-2 text-sm font-medium rounded-md transition-all bg-white shadow text-red-600";
                btnSubmit.className = "w-full py-3 rounded-lg font-bold text-white transition-colors bg-red-600 hover:bg-red-700";
                btnSubmit.innerText = "บันทึกรายจ่าย";
                
                datalist.innerHTML = expenseCategories.map(cat => `<option value="${cat}">`).join('');
            }
            inputCategory.value = '';
        };

        const setViewMode = (mode) => {
            viewMode = mode;
            currentDate = new Date();
            
            // Update Tab Styles
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.className = "view-btn text-gray-500 hover:bg-gray-200 px-4 py-1.5 text-sm font-medium rounded-md whitespace-nowrap transition-all";
            });
            const activeBtn = document.getElementById(`view-btn-${mode}`);
            if(activeBtn) activeBtn.className = "view-btn bg-white shadow text-blue-600 px-4 py-1.5 text-sm font-medium rounded-md whitespace-nowrap transition-all";

            updateUI();
        };

        const navigateDate = (direction) => {
            if (viewMode === 'day') {
                currentDate.setDate(currentDate.getDate() + direction);
            } else if (viewMode === 'week') {
                currentDate.setDate(currentDate.getDate() + (direction * 7));
            } else if (viewMode === 'month') {
                currentDate.setMonth(currentDate.getMonth() + direction);
            } else if (viewMode === 'year') {
                currentDate.setFullYear(currentDate.getFullYear() + direction);
            }
            updateUI();
        };

        const updatePeriodLabel = () => {
            const thMonths = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
            const d = currentDate;
            let label = '';
            
            if (viewMode === 'day') {
                label = `${d.getDate()} ${thMonths[d.getMonth()]} ${d.getFullYear() + 543}`;
            } else if (viewMode === 'week') {
                const firstDay = new Date(d);
                firstDay.setDate(d.getDate() - d.getDay());
                const lastDay = new Date(firstDay);
                lastDay.setDate(firstDay.getDate() + 6);
                label = `${firstDay.getDate()} - ${lastDay.getDate()} ${thMonths[lastDay.getMonth()]} ${lastDay.getFullYear() + 543}`;
            } else if (viewMode === 'month') {
                label = `${thMonths[d.getMonth()]} ${d.getFullYear() + 543}`;
            } else if (viewMode === 'year') {
                label = `ปี ${d.getFullYear() + 543}`;
            }

            document.getElementById('period-label').innerText = label;
            document.getElementById('date-navigator').style.display = viewMode === 'all' ? 'none' : 'flex';
        };

        const getFilteredTransactions = () => {
            return transactions.filter(t => {
                if (viewMode === 'all') return true;

                const tDate = new Date(t.datetime);
                const cDate = new Date(currentDate);

                if (viewMode === 'day') {
                    return tDate.getDate() === cDate.getDate() &&
                           tDate.getMonth() === cDate.getMonth() &&
                           tDate.getFullYear() === cDate.getFullYear();
                }
                if (viewMode === 'week') {
                    const firstDay = new Date(cDate);
                    firstDay.setDate(cDate.getDate() - cDate.getDay());
                    firstDay.setHours(0, 0, 0, 0);
                    const lastDay = new Date(firstDay);
                    lastDay.setDate(firstDay.getDate() + 6);
                    lastDay.setHours(23, 59, 59, 999);
                    return tDate >= firstDay && tDate <= lastDay;
                }
                if (viewMode === 'month') {
                    return tDate.getMonth() === cDate.getMonth() &&
                           tDate.getFullYear() === cDate.getFullYear();
                }
                if (viewMode === 'year') {
                    return tDate.getFullYear() === cDate.getFullYear();
                }
                return true;
            }).sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
        };

        const renderListAndSummary = () => {
            const filtered = getFilteredTransactions();
            const listEl = document.getElementById('transaction-list');
            
            // Calculate Summary
            const summary = filtered.reduce((acc, curr) => {
                if (curr.type === 'income') acc.income += curr.amount;
                else acc.expense += curr.amount;
                acc.balance = acc.income - acc.expense;
                return acc;
            }, { income: 0, expense: 0, balance: 0 });

            // Update Summary DOM
                // animate numeric changes
                const incomeEl = document.getElementById('summary-income');
                const expenseEl = document.getElementById('summary-expense');
                const balEl = document.getElementById('summary-balance');
                const balIconBg = document.getElementById('summary-balance-icon-bg');

                const parseCurrency = (text) => {
                    if (!text) return 0;
                    // remove non-numeric except dot and minus
                    const cleaned = ('' + text).replace(/[^0-9.-]+/g, '');
                    return parseFloat(cleaned) || 0;
                };

                const animateValue = (el, from, to, duration = 520) => {
                    if (!el) return;
                    const start = performance.now();
                    const step = (t) => {
                        const pct = Math.min(1, (t - start) / duration);
                        const val = from + (to - from) * pct;
                        el.innerText = formatCurrency(val);
                        if (pct < 1) requestAnimationFrame(step);
                    };
                    // small pop effect
                    el.classList.add('summary-value-pop');
                    setTimeout(() => el.classList.remove('summary-value-pop'), 420);
                    requestAnimationFrame(step);
                };

                // parse current displayed values
                const curIncome = parseCurrency(incomeEl.innerText);
                const curExpense = parseCurrency(expenseEl.innerText);
                const curBal = parseCurrency(balEl.innerText);

                animateValue(incomeEl, curIncome, summary.income);
                animateValue(expenseEl, curExpense, summary.expense);
                animateValue(balEl, curBal, summary.balance);
            
            if (summary.balance >= 0) {
                balEl.className = "text-xl font-bold text-blue-600";
                balIconBg.className = "p-3 rounded-full bg-blue-100 text-blue-600";
            } else {
                balEl.className = "text-xl font-bold text-orange-600";
                balIconBg.className = "p-3 rounded-full bg-orange-100 text-orange-600";
            }

            // Render List
            if (filtered.length === 0) {
                listEl.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-gray-400 py-10">
                        <i data-lucide="wallet" class="w-12 h-12 mb-3 opacity-20"></i>
                        <p>ไม่มีรายการบันทึกในหมวดหมู่นี้</p>
                    </div>`;
            } else {
                listEl.innerHTML = filtered.map(tx => {
                    const txDate = new Date(tx.datetime);
                    const isIncome = tx.type === 'income';
                    const iconType = isIncome ? 'trending-up' : 'trending-down';
                    const colorClass = isIncome ? 'text-green-600' : 'text-red-600';
                    const bgClass = isIncome ? 'bg-green-100' : 'bg-red-100';
                    const sign = isIncome ? '+' : '-';
                    
                    return `
                        <div data-id="${tx.id}" class="group list-item flex justify-between items-center p-3 sm:p-4 rounded-lg border border-gray-100 hover:border-gray-200 hover:shadow-sm transition-all bg-gray-50/50">
                            <div class="flex items-center gap-3 sm:gap-4 overflow-hidden">
                                <div class="p-2 sm:p-3 rounded-full shrink-0 ${bgClass} ${colorClass}">
                                    <i data-lucide="${iconType}" class="w-5 h-5"></i>
                                </div>
                                <div class="overflow-hidden">
                                    <p class="font-semibold text-gray-800 truncate">${tx.category}</p>
                                    <div class="flex items-center gap-2 text-xs text-gray-500 mt-1">
                                        <span>${txDate.toLocaleDateString('th-TH')}</span>
                                        <span>•</span>
                                        <span>${txDate.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}</span>
                                    </div>
                                    ${tx.note ? `<p class="text-sm text-gray-500 mt-1 truncate">${tx.note}</p>` : ''}
                                </div>
                            </div>
                            
                            <div class="flex flex-col items-end shrink-0 ml-2">
                                <span class="font-bold ${colorClass}">
                                    ${sign}${formatCurrency(tx.amount)}
                                </span>
                                <button data-action="delete" data-id="${tx.id}" class="flex items-center gap-2 text-xs text-red-400 hover:text-red-600 mt-1 opacity-0 group-hover:opacity-100 transition-opacity transform hover:scale-105" aria-label="ลบรายการ">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    <span class="hidden sm:inline">ลบ</span>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                // Smoothly expand any newly rendered items that haven't been animated yet
                requestAnimationFrame(() => {
                    const items = listEl.querySelectorAll('.list-item');
                    items.forEach(item => {
                        if (!item.hasAttribute('data-animated')) {
                            // mark as animated so subsequent renders skip
                            item.setAttribute('data-animated', '1');
                            expandElement(item);
                        }
                    });
                });
            }
            
            // Re-initialize Lucide Icons for newly generated elements
            lucide.createIcons();
            
                // stagger list items (apply small incremental transition delays)
                const items = listEl.querySelectorAll('.list-item');
                items.forEach((it, i) => {
                    // only apply stagger when not already animated via expandElement
                    it.style.transitionDelay = `${i * 40}ms`;
                    // ensure class to pick up explicit delay
                    it.classList.add('stagger-delay');
                    // clear delay after transition completes
                    it.addEventListener('transitionend', function cleanup() { it.style.transitionDelay = ''; it.classList.remove('stagger-delay'); it.removeEventListener('transitionend', cleanup); });
                });
        };

        const updateUI = () => {
            updatePeriodLabel();
            renderListAndSummary();
        };

        // --- Actions ---
        const handleFormSubmit = (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('input-amount').value);
            const category = document.getElementById('input-category').value.trim();
            const datetime = document.getElementById('input-datetime').value;
            const note = document.getElementById('input-note').value.trim();

            if (!amount || isNaN(amount) || amount <= 0) {
                alert('กรุณากรอกจำนวนเงินให้ถูกต้อง');
                return;
            }
            if (!category) {
                alert('กรุณากรอกหมวดหมู่');
                return;
            }

            const newTx = {
                id: Date.now().toString(),
                type: currentFormType,
                amount: amount,
                category: category,
                note: note,
                datetime: datetime
            };

            transactions.unshift(newTx); // Add to beginning
            saveTransactions();
            
            // Reset form fields
            document.getElementById('input-amount').value = '';
            document.getElementById('input-category').value = '';
            document.getElementById('input-note').value = '';
            
            updateUI();
            // microinteraction: animate newly added item and show toast
            const listEl = document.getElementById('transaction-list');
            const firstItem = listEl.querySelector('div');
            if (firstItem) {
                firstItem.classList.add('animate-pop');
                listEl.scrollTo({ top: 0, behavior: 'smooth' });
                setTimeout(() => firstItem.classList.remove('animate-pop'), 480);
            }
            showToast('บันทึกสำเร็จ', 'success');
        };

        const deleteTransaction = (id) => {
            // show animated confirmation modal instead of native confirm
            showConfirmDelete(id);
        };

        const performDelete = (id) => {
            // Find the DOM element and animate exit before removing from data
            const el = document.querySelector(`[data-id="${id}"]`);
            if (el) {
                // Collapse smoothly, then remove from data and show undo snackbar
                const idx = transactions.findIndex(t => t.id === id);
                collapseElement(el, () => {
                    if (idx === -1) {
                        // fallback
                        updateUI();
                        showToast('ลบเรียบร้อย', 'success');
                        return;
                    }
                    // store deleted item for possible undo
                    lastDeleted = { tx: transactions[idx], index: idx };
                    // remove from data and re-render immediately
                    transactions.splice(idx, 1);
                    saveTransactions();
                    updateUI();
                    showUndoSnackbar();
                });
            } else {
                // fallback if element not found
                transactions = transactions.filter(t => t.id !== id);
                saveTransactions();
                updateUI();
                showToast('ลบเรียบร้อย', 'success');
            }
        };

        const exportToCSV = () => {
            const filtered = getFilteredTransactions();
            if (filtered.length === 0) {
                alert('ไม่มีข้อมูลสำหรับส่งออกในช่วงเวลานี้');
                return;
            }

            const headers = ['วันที่', 'เวลา', 'ประเภท', 'หมวดหมู่', 'รายละเอียด', 'จำนวนเงิน (บาท)'];
            
            const rows = filtered.map(t => {
                const d = new Date(t.datetime);
                const dateStr = d.toLocaleDateString('th-TH');
                const timeStr = d.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                const typeStr = t.type === 'income' ? 'รายรับ' : 'รายจ่าย';
                return [
                    `"${dateStr}"`, 
                    `"${timeStr}"`, 
                    `"${typeStr}"`, 
                    `"${t.category}"`, 
                    `"${t.note || '-'}"`, 
                    t.amount
                ].join(',');
            });

            const csvContent = headers.join(',') + '\n' + rows.join('\n');
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `สรุปบัญชี_${viewMode}_${Date.now()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- Initialization ---
        document.getElementById('transaction-form').addEventListener('submit', handleFormSubmit);
        document.getElementById('input-datetime').value = getInitialDateTime();
        
        // Setup initial UI
        lucide.createIcons();
        setFormType('expense'); // Default to expense
        updateUI();

        // Attach ripple effect to buttons
        document.addEventListener('pointerdown', createRipple);

        // Confirmation modal logic
        const showConfirmDelete = (id) => {
            const modal = document.getElementById('confirm-modal');
            if (!modal) return;
            modal.dataset.id = id;
            modal.setAttribute('aria-hidden', 'false');
            // ensure element is visible (hideConfirmModal sets display:none)
            modal.style.display = 'flex';
            // allow browser to apply display before animating
            requestAnimationFrame(() => modal.classList.add('open'));
            // focus the cancel button for safety
            const noBtn = document.getElementById('confirm-no');
            if (noBtn) noBtn.focus();
        };

        const hideConfirmModal = () => {
            const modal = document.getElementById('confirm-modal');
            if (!modal) return;
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
            setTimeout(() => { modal.style.display = 'none'; }, 240);
        };

        // wire modal buttons
        const confirmYes = document.getElementById('confirm-yes');
        const confirmNo = document.getElementById('confirm-no');
        if (confirmYes) confirmYes.addEventListener('click', (e) => {
            const modal = document.getElementById('confirm-modal');
            const id = modal && modal.dataset ? modal.dataset.id : null;
            hideConfirmModal();
            if (id) performDelete(id);
        });
        if (confirmNo) confirmNo.addEventListener('click', (e) => {
            hideConfirmModal();
        });


    </script>
</body>
</html> 
